{% extends "base.html" %}
{% load static %}

{% block title %}Listado de Sensores - AgroSENA{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components/cards.css' %}">
<style>
    .sensor-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }
    
    .sensor-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }
    
    .sensor-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    .sensor-status {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
    }
    
    .status-active {
        background-color: #28a745;
    }
    
    .status-inactive {
        background-color: #dc3545;
    }
    
    .sensor-actions {
        margin-top: 15px;
        display: flex;
        gap: 10px;
    }
    
    .no-sensors {
        grid-column: 1 / -1;
        text-align: center;
        padding: 40px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="section-header">
        <h2 class="section-title">üå°Ô∏è Sensores Registrados</h2>
        {% if request.user.is_authenticated and request.user.is_staff %}
            <a href="{% url 'sensor-create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> A√±adir Sensor
            </a>
        {% endif %}
    </div>

    {% if request.user.is_authenticated %}
        <div class="sensor-grid">
            {% for sensor in object_list %}
            <div class="sensor-card">
                <h3>{{ sensor.nombre }}</h3>
                <p><strong>Tipo:</strong> {{ sensor.get_tipo_display }}</p>
                <p><strong>Ubicaci√≥n:</strong> {{ sensor.ubicacion }}</p>
                <p>
                    <strong>Estado:</strong> 
                    <span class="sensor-status {% if sensor.activo %}status-active{% else %}status-inactive{% endif %}"></span>
                    {{ sensor.activo|yesno:"Activo,Inactivo" }}
                </p>
                <p><strong>√öltima lectura:</strong> 
                    {% if sensor.ultima_medicion %}
                        {{ sensor.ultima_medicion.valor }} ({{ sensor.ultima_medicion.timestamp|timesince }})
                    {% else %}
                        Sin datos
                    {% endif %}
                </p>
                
                <div class="sensor-actions">
                    <a href="{% url 'sensor-detail' sensor.pk %}" class="btn btn-secondary">
                        <i class="fas fa-info-circle"></i> Detalle
                    </a>
                    {% if request.user.is_staff %}
                        <form action="{% url 'sensor-toggle' sensor.pk %}" method="post" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-{% if sensor.activo %}warning{% else %}success{% endif %}">
                                <i class="fas fa-power-off"></i> {% if sensor.activo %}Desactivar{% else %}Activar{% endif %}
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="no-sensors">
                <p>No hay sensores registrados.</p>
                {% if request.user.is_staff %}
                    <a href="{% url 'sensor-create' %}" class="btn btn-primary mt-3">
                        <i class="fas fa-plus"></i> A√±adir Primer Sensor
                    </a>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> 
            Debes <a href="{% url 'login' %}?next={{ request.path }}">iniciar sesi√≥n</a> para ver los sensores.
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Puedes a√±adir funcionalidad JavaScript aqu√≠ si es necesario
document.addEventListener('DOMContentLoaded', function() {
    // Ejemplo: Confirmaci√≥n antes de desactivar un sensor
    const toggleButtons = document.querySelectorAll('form[action*="sensor-toggle"] button');
    toggleButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            const action = this.innerText.includes('Desactivar') ? 'desactivar' : 'activar';
            if (!confirm(`¬øEst√°s seguro que quieres ${action} este sensor?`)) {
                e.preventDefault();
            }
        });
    });
});
</script>
{% endblock %}